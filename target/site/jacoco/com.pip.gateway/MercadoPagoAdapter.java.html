<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MercadoPagoAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Payment Integration Platform</a> &gt; <a href="index.source.html" class="el_package">com.pip.gateway</a> &gt; <span class="el_source">MercadoPagoAdapter.java</span></div><h1>MercadoPagoAdapter.java</h1><pre class="source lang-java linenums">package com.pip.gateway;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.pip.dto.AuthorizationRequest;
import com.pip.dto.CaptureRequest;
import com.pip.dto.VoidRequest;
import com.pip.dto.PaymentResponse;
import com.pip.model.Gateway;
import com.pip.model.Transacao;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.*;
import org.springframework.stereotype.Component;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.HttpServerErrorException;
import org.springframework.web.client.RestTemplate;

import java.time.ZonedDateTime;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * Adaptador REAL para integração com Mercado Pago
 * 
 * Implementação 100% conforme documentação oficial:
 * https://www.mercadopago.com.ar/developers/en/reference/payments/_payments/post
 * https://www.mercadopago.com.ar/developers/en/docs/checkout-api/payment-management/capture-authorized-payment
 * 
 * Características:
 * - Autenticação via Bearer Token (Access Token OAuth)
 * - Ambiente Único: https://api.mercadopago.com
 * - Suporta: Credit Card, Debit Card, PIX, Boleto
 * - Captura: 7 dias da criação
 * - Valores em formato decimal (R$10,00 = 10.00)
 * 
 * Segurança:
 * - TLS 1.2+ obrigatório
 * - PCI-DSS Level 1 compliant
 * - Tokenização de cartões obrigatória
 * - Logs de auditoria completos
 * - Sanitização de dados sensíveis
 * 
 * @author Luiz Gustavo Finotello
 * @version 3.0 - 100% Conforme Documentação Oficial
 */
@Component
<span class="nc" id="L49">public class MercadoPagoAdapter implements GatewayAdapter {</span>

<span class="nc" id="L51">    private static final Logger logger = LoggerFactory.getLogger(MercadoPagoAdapter.class);</span>
    private static final String GATEWAY_CODE = &quot;MERCADOPAGO&quot;;
    
    // Mercado Pago usa mesma URL para sandbox e produção
    // Diferenciação é feita pelo Access Token (test vs production)
    private static final String API_URL = &quot;https://api.mercadopago.com&quot;;

    @Autowired
    private RestTemplate restTemplate;

    @Autowired
    private ObjectMapper objectMapper;

    @Override
    public PaymentResponse authorize(Gateway gateway, AuthorizationRequest request, Transacao transacao) {
<span class="nc" id="L66">        logger.info(&quot;[MERCADOPAGO] Iniciando autorização - TransactionID: {}&quot;, transacao.getTransactionId());</span>
        
        try {
<span class="nc" id="L69">            validateRequest(request);</span>
            
<span class="nc" id="L71">            Map&lt;String, Object&gt; payload = buildCompletePayload(request, transacao);</span>
<span class="nc" id="L72">            HttpHeaders headers = buildHeaders(gateway);</span>
            
<span class="nc" id="L74">            String url = API_URL + &quot;/v1/payments&quot;;</span>
<span class="nc" id="L75">            HttpEntity&lt;Map&lt;String, Object&gt;&gt; entity = new HttpEntity&lt;&gt;(payload, headers);</span>
            
<span class="nc" id="L77">            logger.debug(&quot;[MERCADOPAGO] Enviando requisição para: {}&quot;, url);</span>
            
<span class="nc" id="L79">            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.POST,
                entity,
                Map.class
            );

<span class="nc" id="L86">            return processAuthorizationResponse(response, transacao);</span>

<span class="nc" id="L88">        } catch (HttpClientErrorException e) {</span>
<span class="nc" id="L89">            logger.error(&quot;[MERCADOPAGO] Erro 4xx: {} - {}&quot;, e.getStatusCode(), sanitizeLog(e.getResponseBodyAsString()));</span>
<span class="nc" id="L90">            return createErrorResponse(&quot;AUTHORIZATION_FAILED&quot;, parseErrorMessage(e.getResponseBodyAsString()));</span>
<span class="nc" id="L91">        } catch (Exception e) {</span>
<span class="nc" id="L92">            logger.error(&quot;[MERCADOPAGO] Erro inesperado&quot;, e);</span>
<span class="nc" id="L93">            return createErrorResponse(&quot;SYSTEM_ERROR&quot;, e.getMessage());</span>
        }
    }

    @Override
    public PaymentResponse capture(Gateway gateway, CaptureRequest request, Transacao transacao) {
<span class="nc" id="L99">        logger.info(&quot;[MERCADOPAGO] Iniciando captura - TransactionID: {}&quot;, transacao.getTransactionId());</span>

        try {
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (transacao.getGatewayTransactionId() == null) {</span>
<span class="nc" id="L103">                return createErrorResponse(&quot;INVALID_TRANSACTION&quot;, &quot;Payment ID não encontrado&quot;);</span>
            }
            
<span class="nc" id="L106">            HttpHeaders headers = buildHeaders(gateway);</span>

            // Captura usando PUT /v1/payments/{id}
<span class="nc" id="L109">            String url = String.format(&quot;%s/v1/payments/%s&quot;,</span>
                API_URL,
<span class="nc" id="L111">                transacao.getGatewayTransactionId()</span>
            );
            
<span class="nc" id="L114">            Map&lt;String, Object&gt; body = new HashMap&lt;&gt;();</span>
<span class="nc" id="L115">            body.put(&quot;capture&quot;, true);</span>
            
<span class="nc bnc" id="L117" title="All 4 branches missed.">            if (request.getAmount() != null &amp;&amp; request.getAmount().compareTo(java.math.BigDecimal.ZERO) &gt; 0) {</span>
<span class="nc" id="L118">                body.put(&quot;transaction_amount&quot;, request.getAmount());</span>
            }

<span class="nc" id="L121">            HttpEntity&lt;Map&lt;String, Object&gt;&gt; entity = new HttpEntity&lt;&gt;(body, headers);</span>
            
<span class="nc" id="L123">            logger.debug(&quot;[MERCADOPAGO] Enviando captura para: {}&quot;, url);</span>
            
<span class="nc" id="L125">            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.PUT,
                entity,
                Map.class
            );

<span class="nc bnc" id="L132" title="All 2 branches missed.">            if (response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L133">                Map&lt;String, Object&gt; responseBody = response.getBody();</span>
                
<span class="nc" id="L135">                PaymentResponse paymentResponse = new PaymentResponse();</span>
<span class="nc" id="L136">                paymentResponse.setSuccess(true);</span>
<span class="nc" id="L137">                paymentResponse.setStatus(&quot;CAPTURED&quot;);</span>
<span class="nc" id="L138">                paymentResponse.setTransactionId(transacao.getTransactionId());</span>
<span class="nc" id="L139">                paymentResponse.setGatewayTransactionId(String.valueOf(responseBody.get(&quot;id&quot;)));</span>
                
<span class="nc bnc" id="L141" title="All 2 branches missed.">                if (responseBody.containsKey(&quot;authorization_code&quot;)) {</span>
<span class="nc" id="L142">                    paymentResponse.setAuthorizationCode((String) responseBody.get(&quot;authorization_code&quot;));</span>
                }
                
<span class="nc" id="L145">                paymentResponse.setTimestamp(ZonedDateTime.now());</span>

<span class="nc" id="L147">                logger.info(&quot;[MERCADOPAGO] Captura bem-sucedida: {}&quot;, transacao.getGatewayTransactionId());</span>
<span class="nc" id="L148">                return paymentResponse;</span>
            } else {
<span class="nc" id="L150">                return createErrorResponse(&quot;CAPTURE_FAILED&quot;, &quot;Falha na captura&quot;);</span>
            }

<span class="nc" id="L153">        } catch (Exception e) {</span>
<span class="nc" id="L154">            logger.error(&quot;[MERCADOPAGO] Erro na captura&quot;, e);</span>
<span class="nc" id="L155">            return createErrorResponse(&quot;GATEWAY_ERROR&quot;, e.getMessage());</span>
        }
    }

    @Override
    public PaymentResponse voidTransaction(Gateway gateway, VoidRequest request, Transacao transacao) {
<span class="nc" id="L161">        logger.info(&quot;[MERCADOPAGO] Iniciando cancelamento - TransactionID: {}&quot;, transacao.getTransactionId());</span>

        try {
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (transacao.getGatewayTransactionId() == null) {</span>
<span class="nc" id="L165">                return createErrorResponse(&quot;INVALID_TRANSACTION&quot;, &quot;Payment ID não encontrado&quot;);</span>
            }
            
<span class="nc" id="L168">            HttpHeaders headers = buildHeaders(gateway);</span>

            // Cancelamento usando PUT /v1/payments/{id} com status=cancelled
<span class="nc" id="L171">            String url = String.format(&quot;%s/v1/payments/%s&quot;,</span>
                API_URL,
<span class="nc" id="L173">                transacao.getGatewayTransactionId()</span>
            );
            
<span class="nc" id="L176">            Map&lt;String, Object&gt; body = new HashMap&lt;&gt;();</span>
<span class="nc" id="L177">            body.put(&quot;status&quot;, &quot;cancelled&quot;);</span>

<span class="nc" id="L179">            HttpEntity&lt;Map&lt;String, Object&gt;&gt; entity = new HttpEntity&lt;&gt;(body, headers);</span>
            
<span class="nc" id="L181">            logger.debug(&quot;[MERCADOPAGO] Enviando cancelamento para: {}&quot;, url);</span>
            
<span class="nc" id="L183">            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.PUT,
                entity,
                Map.class
            );

<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L191">                PaymentResponse paymentResponse = new PaymentResponse();</span>
<span class="nc" id="L192">                paymentResponse.setSuccess(true);</span>
<span class="nc" id="L193">                paymentResponse.setStatus(&quot;VOIDED&quot;);</span>
<span class="nc" id="L194">                paymentResponse.setTransactionId(transacao.getTransactionId());</span>
<span class="nc" id="L195">                paymentResponse.setGatewayTransactionId(transacao.getGatewayTransactionId());</span>
<span class="nc" id="L196">                paymentResponse.setTimestamp(ZonedDateTime.now());</span>

<span class="nc" id="L198">                logger.info(&quot;[MERCADOPAGO] Cancelamento bem-sucedido: {}&quot;, transacao.getGatewayTransactionId());</span>
<span class="nc" id="L199">                return paymentResponse;</span>
            } else {
<span class="nc" id="L201">                return createErrorResponse(&quot;VOID_FAILED&quot;, &quot;Falha no cancelamento&quot;);</span>
            }

<span class="nc" id="L204">        } catch (Exception e) {</span>
<span class="nc" id="L205">            logger.error(&quot;[MERCADOPAGO] Erro no cancelamento&quot;, e);</span>
<span class="nc" id="L206">            return createErrorResponse(&quot;GATEWAY_ERROR&quot;, e.getMessage());</span>
        }
    }

    @Override
    public boolean healthCheck(Gateway gateway) {
        try {
<span class="nc" id="L213">            HttpHeaders headers = buildHeaders(gateway);</span>
<span class="nc" id="L214">            String url = API_URL + &quot;/v1/payment_methods&quot;;</span>
            
<span class="nc" id="L216">            HttpEntity&lt;Void&gt; entity = new HttpEntity&lt;&gt;(headers);</span>
            
<span class="nc" id="L218">            ResponseEntity&lt;Object&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.GET,
                entity,
                Object.class
            );
            
<span class="nc bnc" id="L225" title="All 2 branches missed.">            return response.getStatusCode() == HttpStatus.OK;</span>

<span class="nc" id="L227">        } catch (Exception e) {</span>
<span class="nc" id="L228">            logger.warn(&quot;[MERCADOPAGO] Health check falhou: {}&quot;, e.getMessage());</span>
<span class="nc" id="L229">            return false;</span>
        }
    }

    @Override
    public String getGatewayCode() {
<span class="nc" id="L235">        return GATEWAY_CODE;</span>
    }

    // ========== MÉTODOS PRIVADOS ==========

    private void validateRequest(AuthorizationRequest request) {
<span class="nc bnc" id="L241" title="All 4 branches missed.">        if (request.getAmount() == null || request.getAmount() &lt;= 0) {</span>
<span class="nc" id="L242">            throw new IllegalArgumentException(&quot;transaction_amount inválido&quot;);</span>
        }
<span class="nc bnc" id="L244" title="All 4 branches missed.">        if (request.getCardToken() == null || request.getCardToken().isEmpty()) {</span>
<span class="nc" id="L245">            throw new IllegalArgumentException(&quot;token obrigatório&quot;);</span>
        }
<span class="nc bnc" id="L247" title="All 4 branches missed.">        if (request.getInstallments() == null || request.getInstallments() &lt; 1) {</span>
<span class="nc" id="L248">            throw new IllegalArgumentException(&quot;installments obrigatório&quot;);</span>
        }
<span class="nc" id="L250">    }</span>

    private Map&lt;String, Object&gt; buildCompletePayload(AuthorizationRequest request, Transacao transacao) {
<span class="nc" id="L253">        Map&lt;String, Object&gt; payload = new HashMap&lt;&gt;();</span>
        
        // token (obrigatório) - card token
<span class="nc" id="L256">        payload.put(&quot;token&quot;, request.getCardToken());</span>
        
        // transaction_amount (obrigatório) - valor decimal
<span class="nc" id="L259">        payload.put(&quot;transaction_amount&quot;, request.getAmount());</span>
        
        // installments (obrigatório) - número de parcelas
<span class="nc" id="L262">        payload.put(&quot;installments&quot;, request.getInstallments());</span>
        
        // payment_method_id (obrigatório) - será inferido do token
        // Mas pode ser especificado: visa, master, amex, etc
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (request.getPaymentMethod() != null) {</span>
<span class="nc" id="L267">            payload.put(&quot;payment_method_id&quot;, request.getPaymentMethod());</span>
        }
        
        // payer (obrigatório)
<span class="nc" id="L271">        Map&lt;String, Object&gt; payer = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        payer.put(&quot;email&quot;, request.getCustomerEmail() != null ? request.getCustomerEmail() : &quot;test@test.com&quot;);</span>
        
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (request.getCustomerDocument() != null) {</span>
<span class="nc" id="L275">            Map&lt;String, Object&gt; identification = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            identification.put(&quot;type&quot;, request.getCustomerDocument().length() == 11 ? &quot;CPF&quot; : &quot;CNPJ&quot;);</span>
<span class="nc" id="L277">            identification.put(&quot;number&quot;, request.getCustomerDocument());</span>
<span class="nc" id="L278">            payer.put(&quot;identification&quot;, identification);</span>
        }
        
<span class="nc" id="L281">        payload.put(&quot;payer&quot;, payer);</span>
        
        // capture (opcional) - false para autorização apenas
<span class="nc" id="L284">        payload.put(&quot;capture&quot;, false);</span>
        
        // external_reference (opcional) - identificador externo
<span class="nc" id="L287">        payload.put(&quot;external_reference&quot;, transacao.getTransactionId());</span>
        
        // description (opcional)
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (request.getDescription() != null) {</span>
<span class="nc" id="L291">            payload.put(&quot;description&quot;, request.getDescription());</span>
        }
        
        // statement_descriptor (opcional) - nome na fatura
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (request.getSoftDescriptor() != null) {</span>
<span class="nc" id="L296">            payload.put(&quot;statement_descriptor&quot;, request.getSoftDescriptor());</span>
        }
        
        // notification_url (opcional) - webhook HTTPS
<span class="nc bnc" id="L300" title="All 4 branches missed.">        if (request.getNotificationUrl() != null &amp;&amp; request.getNotificationUrl().startsWith(&quot;https://&quot;)) {</span>
<span class="nc" id="L301">            payload.put(&quot;notification_url&quot;, request.getNotificationUrl());</span>
        }
        
        // metadata (opcional) - dados adicionais
<span class="nc" id="L305">        Map&lt;String, Object&gt; metadata = new HashMap&lt;&gt;();</span>
<span class="nc" id="L306">        metadata.put(&quot;platform&quot;, &quot;PIP&quot;);</span>
<span class="nc" id="L307">        metadata.put(&quot;version&quot;, &quot;3.0&quot;);</span>
<span class="nc" id="L308">        payload.put(&quot;metadata&quot;, metadata);</span>
        
<span class="nc" id="L310">        logger.debug(&quot;[MERCADOPAGO] Payload construído com {} campos&quot;, payload.size());</span>
        
<span class="nc" id="L312">        return payload;</span>
    }

    private HttpHeaders buildHeaders(Gateway gateway) {
<span class="nc" id="L316">        HttpHeaders headers = new HttpHeaders();</span>
<span class="nc" id="L317">        headers.setContentType(MediaType.APPLICATION_JSON);</span>
        
        // Access Token (test ou production)
<span class="nc" id="L320">        headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + gateway.getApiKey());</span>
        
        // X-Idempotency-Key (recomendado para evitar duplicatas)
<span class="nc" id="L323">        headers.set(&quot;X-Idempotency-Key&quot;, UUID.randomUUID().toString());</span>
        
<span class="nc" id="L325">        return headers;</span>
    }

    private PaymentResponse processAuthorizationResponse(ResponseEntity&lt;Map&gt; response, Transacao transacao) {
<span class="nc bnc" id="L329" title="All 4 branches missed.">        if (response.getStatusCode() == HttpStatus.CREATED || response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L330">            Map&lt;String, Object&gt; responseBody = response.getBody();</span>

<span class="nc" id="L332">            PaymentResponse paymentResponse = new PaymentResponse();</span>
            
            // status: approved, authorized, pending, in_process, rejected, cancelled, refunded, charged_back
<span class="nc" id="L335">            String status = (String) responseBody.get(&quot;status&quot;);</span>
<span class="nc bnc" id="L336" title="All 4 branches missed.">            boolean isAuthorized = &quot;authorized&quot;.equals(status) || &quot;approved&quot;.equals(status);</span>
            
<span class="nc" id="L338">            paymentResponse.setSuccess(isAuthorized);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            paymentResponse.setStatus(isAuthorized ? &quot;AUTHORIZED&quot; : &quot;DENIED&quot;);</span>
<span class="nc" id="L340">            paymentResponse.setTransactionId(transacao.getTransactionId());</span>
<span class="nc" id="L341">            paymentResponse.setGatewayTransactionId(String.valueOf(responseBody.get(&quot;id&quot;)));</span>
            
<span class="nc bnc" id="L343" title="All 2 branches missed.">            if (responseBody.containsKey(&quot;authorization_code&quot;)) {</span>
<span class="nc" id="L344">                paymentResponse.setAuthorizationCode((String) responseBody.get(&quot;authorization_code&quot;));</span>
            }
            
<span class="nc bnc" id="L347" title="All 4 branches missed.">            if (!isAuthorized &amp;&amp; responseBody.containsKey(&quot;status_detail&quot;)) {</span>
<span class="nc" id="L348">                paymentResponse.setErrorMessage((String) responseBody.get(&quot;status_detail&quot;));</span>
            }
            
<span class="nc bnc" id="L351" title="All 2 branches missed.">            if (responseBody.containsKey(&quot;card&quot;)) {</span>
<span class="nc" id="L352">                Map&lt;String, Object&gt; card = (Map&lt;String, Object&gt;) responseBody.get(&quot;card&quot;);</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                if (card.containsKey(&quot;first_six_digits&quot;)) {</span>
<span class="nc" id="L354">                    paymentResponse.setCardBrand(identifyBrand((String) card.get(&quot;first_six_digits&quot;)));</span>
                }
            }
            
<span class="nc" id="L358">            paymentResponse.setTimestamp(ZonedDateTime.now());</span>

<span class="nc" id="L360">            logger.info(&quot;[MERCADOPAGO] Autorização processada: {} - Status: {}&quot;, </span>
<span class="nc" id="L361">                paymentResponse.getGatewayTransactionId(), </span>
                status);
            
<span class="nc" id="L364">            return paymentResponse;</span>
        } else {
<span class="nc" id="L366">            return createErrorResponse(&quot;AUTHORIZATION_FAILED&quot;, &quot;Falha na autorização&quot;);</span>
        }
    }

    private String identifyBrand(String bin) {
<span class="nc bnc" id="L371" title="All 2 branches missed.">        if (bin.startsWith(&quot;4&quot;)) return &quot;VISA&quot;;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (bin.startsWith(&quot;5&quot;)) return &quot;MASTERCARD&quot;;</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (bin.startsWith(&quot;3&quot;)) return &quot;AMEX&quot;;</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (bin.startsWith(&quot;6&quot;)) return &quot;ELO&quot;;</span>
<span class="nc" id="L375">        return &quot;UNKNOWN&quot;;</span>
    }

    private String sanitizeLog(String log) {
<span class="nc bnc" id="L379" title="All 2 branches missed.">        if (log == null) return &quot;&quot;;</span>
        
<span class="nc" id="L381">        return log.replaceAll(&quot;\\d{13,19}&quot;, &quot;****&quot;)</span>
<span class="nc" id="L382">                  .replaceAll(&quot;token[\&quot;:]\\s*\\d+&quot;, &quot;token\&quot;:\&quot;****\&quot;&quot;)</span>
<span class="nc" id="L383">                  .replaceAll(&quot;security_code[\&quot;:]\\s*\\d{3,4}&quot;, &quot;security_code\&quot;:\&quot;***\&quot;&quot;);</span>
    }

    private String parseErrorMessage(String responseBody) {
        try {
<span class="nc" id="L388">            Map&lt;String, Object&gt; errorBody = objectMapper.readValue(responseBody, Map.class);</span>
            
<span class="nc bnc" id="L390" title="All 2 branches missed.">            if (errorBody.containsKey(&quot;message&quot;)) {</span>
<span class="nc" id="L391">                return (String) errorBody.get(&quot;message&quot;);</span>
            }
            
<span class="nc bnc" id="L394" title="All 2 branches missed.">            if (errorBody.containsKey(&quot;cause&quot;)) {</span>
<span class="nc" id="L395">                java.util.List&lt;Map&lt;String, Object&gt;&gt; causes = (java.util.List&lt;Map&lt;String, Object&gt;&gt;) errorBody.get(&quot;cause&quot;);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                if (!causes.isEmpty()) {</span>
<span class="nc" id="L397">                    return (String) causes.get(0).get(&quot;description&quot;);</span>
                }
            }
<span class="nc" id="L400">        } catch (Exception e) {</span>
<span class="nc" id="L401">            logger.debug(&quot;[MERCADOPAGO] Não foi possível parsear mensagem de erro&quot;);</span>
<span class="nc" id="L402">        }</span>
<span class="nc" id="L403">        return &quot;Erro na transação&quot;;</span>
    }

    private PaymentResponse createErrorResponse(String errorCode, String errorMessage) {
<span class="nc" id="L407">        PaymentResponse response = new PaymentResponse();</span>
<span class="nc" id="L408">        response.setSuccess(false);</span>
<span class="nc" id="L409">        response.setErrorCode(errorCode);</span>
<span class="nc" id="L410">        response.setErrorMessage(errorMessage);</span>
<span class="nc" id="L411">        response.setTimestamp(ZonedDateTime.now());</span>
        
<span class="nc" id="L413">        logger.warn(&quot;[MERCADOPAGO] Erro: {} - {}&quot;, errorCode, errorMessage);</span>
        
<span class="nc" id="L415">        return response;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>