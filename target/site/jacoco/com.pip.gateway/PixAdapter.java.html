<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PixAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Payment Integration Platform</a> &gt; <a href="index.source.html" class="el_package">com.pip.gateway</a> &gt; <span class="el_source">PixAdapter.java</span></div><h1>PixAdapter.java</h1><pre class="source lang-java linenums">package com.pip.gateway;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.pip.dto.AuthorizationRequest;
import com.pip.dto.CaptureRequest;
import com.pip.dto.VoidRequest;
import com.pip.dto.PaymentResponse;
import com.pip.model.Gateway;
import com.pip.model.Transacao;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.*;
import org.springframework.stereotype.Component;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.HttpServerErrorException;
import org.springframework.web.client.RestTemplate;

import java.time.ZonedDateTime;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * Adaptador REAL para integração com Pix
 * 
 * Implementa comunicação com API Pix seguindo documentação oficial:
 * https://www.bcb.gov.br/estabilidadefinanceira/pix
 * 
 * Características:
 * - Autenticação via Certificate
 * - Ambiente Sandbox: https://pix-h.bcb.gov.br
 * - Ambiente Produção: https://pix.bcb.gov.br
 * - Suporta: Autorização, Captura, Cancelamento
 * 
 * Segurança:
 * - TLS 1.2+ obrigatório
 * - PCI-DSS compliant
 * - Logs de auditoria completos
 * - Validação rigorosa de entrada
 * 
 * @author Luiz Gustavo Finotello
 * @version 2.0 - Integração Real
 */
@Component
<span class="nc" id="L46">public class PixAdapter implements GatewayAdapter {</span>

<span class="nc" id="L48">    private static final Logger logger = LoggerFactory.getLogger(PixAdapter.class);</span>
    private static final String GATEWAY_CODE = &quot;PIX&quot;;
    
    private static final String SANDBOX_URL = &quot;https://pix-h.bcb.gov.br&quot;;
    private static final String PRODUCTION_URL = &quot;https://pix.bcb.gov.br&quot;;

    @Autowired
    private RestTemplate restTemplate;

    @Autowired
    private ObjectMapper objectMapper;

    @Override
    public PaymentResponse authorize(Gateway gateway, AuthorizationRequest request, Transacao transacao) {
<span class="nc" id="L62">        logger.info(&quot;[PIX] Iniciando autorização - TransactionID: {}&quot;, transacao.getTransactionId());</span>
        
        try {
<span class="nc" id="L65">            validateRequest(request);</span>
            
<span class="nc" id="L67">            Map&lt;String, Object&gt; payload = buildAuthorizationPayload(request, transacao);</span>
<span class="nc" id="L68">            HttpHeaders headers = buildHeaders(gateway);</span>
            
<span class="nc" id="L70">            String url = getBaseUrl(gateway) + &quot;/payments&quot;;</span>
<span class="nc" id="L71">            HttpEntity&lt;Map&lt;String, Object&gt;&gt; entity = new HttpEntity&lt;&gt;(payload, headers);</span>
            
<span class="nc" id="L73">            logger.debug(&quot;[PIX] Enviando requisição para: {}&quot;, url);</span>
            
<span class="nc" id="L75">            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.POST,
                entity,
                Map.class
            );

<span class="nc" id="L82">            return processAuthorizationResponse(response, transacao);</span>

<span class="nc" id="L84">        } catch (HttpClientErrorException e) {</span>
<span class="nc" id="L85">            logger.error(&quot;[PIX] Erro 4xx na autorização: {} - {}&quot;, e.getStatusCode(), e.getResponseBodyAsString());</span>
<span class="nc" id="L86">            return createErrorResponse(&quot;AUTHORIZATION_FAILED&quot;, &quot;Erro na autorização: &quot; + e.getMessage());</span>
<span class="nc" id="L87">        } catch (HttpServerErrorException e) {</span>
<span class="nc" id="L88">            logger.error(&quot;[PIX] Erro 5xx na autorização: {} - {}&quot;, e.getStatusCode(), e.getResponseBodyAsString());</span>
<span class="nc" id="L89">            return createErrorResponse(&quot;GATEWAY_ERROR&quot;, &quot;Erro no gateway: &quot; + e.getMessage());</span>
<span class="nc" id="L90">        } catch (Exception e) {</span>
<span class="nc" id="L91">            logger.error(&quot;[PIX] Erro inesperado na autorização&quot;, e);</span>
<span class="nc" id="L92">            return createErrorResponse(&quot;SYSTEM_ERROR&quot;, &quot;Erro no sistema: &quot; + e.getMessage());</span>
        }
    }

    @Override
    public PaymentResponse capture(Gateway gateway, CaptureRequest request, Transacao transacao) {
<span class="nc" id="L98">        logger.info(&quot;[PIX] Iniciando captura - TransactionID: {}&quot;, transacao.getTransactionId());</span>

        try {
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (transacao.getGatewayTransactionId() == null) {</span>
<span class="nc" id="L102">                return createErrorResponse(&quot;INVALID_TRANSACTION&quot;, &quot;TransactionId não encontrado&quot;);</span>
            }
            
<span class="nc" id="L105">            HttpHeaders headers = buildHeaders(gateway);</span>
<span class="nc" id="L106">            String url = String.format(&quot;%s/payments/%s/capture&quot;,</span>
<span class="nc" id="L107">                getBaseUrl(gateway),</span>
<span class="nc" id="L108">                transacao.getGatewayTransactionId()</span>
            );

<span class="nc" id="L111">            Map&lt;String, Object&gt; payload = new HashMap&lt;&gt;();</span>
<span class="nc" id="L112">            payload.put(&quot;amount&quot;, request.getAmount());</span>

<span class="nc" id="L114">            HttpEntity&lt;Map&lt;String, Object&gt;&gt; entity = new HttpEntity&lt;&gt;(payload, headers);</span>
            
<span class="nc" id="L116">            logger.debug(&quot;[PIX] Enviando captura para: {}&quot;, url);</span>
            
<span class="nc" id="L118">            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.POST,
                entity,
                Map.class
            );

<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L126">                PaymentResponse paymentResponse = new PaymentResponse();</span>
<span class="nc" id="L127">                paymentResponse.setSuccess(true);</span>
<span class="nc" id="L128">                paymentResponse.setStatus(&quot;CAPTURED&quot;);</span>
<span class="nc" id="L129">                paymentResponse.setTransactionId(transacao.getTransactionId());</span>
<span class="nc" id="L130">                paymentResponse.setGatewayTransactionId(transacao.getGatewayTransactionId());</span>
<span class="nc" id="L131">                paymentResponse.setTimestamp(ZonedDateTime.now());</span>

<span class="nc" id="L133">                logger.info(&quot;[PIX] Captura bem-sucedida: {}&quot;, transacao.getGatewayTransactionId());</span>
<span class="nc" id="L134">                return paymentResponse;</span>
            } else {
<span class="nc" id="L136">                return createErrorResponse(&quot;CAPTURE_FAILED&quot;, &quot;Falha na captura&quot;);</span>
            }

<span class="nc" id="L139">        } catch (Exception e) {</span>
<span class="nc" id="L140">            logger.error(&quot;[PIX] Erro na captura&quot;, e);</span>
<span class="nc" id="L141">            return createErrorResponse(&quot;GATEWAY_ERROR&quot;, e.getMessage());</span>
        }
    }

    @Override
    public PaymentResponse voidTransaction(Gateway gateway, VoidRequest request, Transacao transacao) {
<span class="nc" id="L147">        logger.info(&quot;[PIX] Iniciando cancelamento - TransactionID: {}&quot;, transacao.getTransactionId());</span>

        try {
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (transacao.getGatewayTransactionId() == null) {</span>
<span class="nc" id="L151">                return createErrorResponse(&quot;INVALID_TRANSACTION&quot;, &quot;TransactionId não encontrado&quot;);</span>
            }
            
<span class="nc" id="L154">            HttpHeaders headers = buildHeaders(gateway);</span>
<span class="nc" id="L155">            String url = String.format(&quot;%s/payments/%s/void&quot;,</span>
<span class="nc" id="L156">                getBaseUrl(gateway),</span>
<span class="nc" id="L157">                transacao.getGatewayTransactionId()</span>
            );

<span class="nc" id="L160">            HttpEntity&lt;Void&gt; entity = new HttpEntity&lt;&gt;(headers);</span>
            
<span class="nc" id="L162">            logger.debug(&quot;[PIX] Enviando cancelamento para: {}&quot;, url);</span>
            
<span class="nc" id="L164">            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.POST,
                entity,
                Map.class
            );

<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L172">                PaymentResponse paymentResponse = new PaymentResponse();</span>
<span class="nc" id="L173">                paymentResponse.setSuccess(true);</span>
<span class="nc" id="L174">                paymentResponse.setStatus(&quot;VOIDED&quot;);</span>
<span class="nc" id="L175">                paymentResponse.setTransactionId(transacao.getTransactionId());</span>
<span class="nc" id="L176">                paymentResponse.setGatewayTransactionId(transacao.getGatewayTransactionId());</span>
<span class="nc" id="L177">                paymentResponse.setTimestamp(ZonedDateTime.now());</span>

<span class="nc" id="L179">                logger.info(&quot;[PIX] Cancelamento bem-sucedido: {}&quot;, transacao.getGatewayTransactionId());</span>
<span class="nc" id="L180">                return paymentResponse;</span>
            } else {
<span class="nc" id="L182">                return createErrorResponse(&quot;VOID_FAILED&quot;, &quot;Falha no cancelamento&quot;);</span>
            }

<span class="nc" id="L185">        } catch (Exception e) {</span>
<span class="nc" id="L186">            logger.error(&quot;[PIX] Erro no cancelamento&quot;, e);</span>
<span class="nc" id="L187">            return createErrorResponse(&quot;GATEWAY_ERROR&quot;, e.getMessage());</span>
        }
    }

    @Override
    public boolean healthCheck(Gateway gateway) {
        try {
<span class="nc" id="L194">            HttpHeaders headers = buildHeaders(gateway);</span>
<span class="nc" id="L195">            String url = getBaseUrl(gateway) + &quot;/health&quot;;</span>
<span class="nc" id="L196">            HttpEntity&lt;Void&gt; entity = new HttpEntity&lt;&gt;(headers);</span>
            
<span class="nc" id="L198">            ResponseEntity&lt;String&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.GET,
                entity,
                String.class
            );

<span class="nc" id="L205">            return response.getStatusCode().is2xxSuccessful();</span>

<span class="nc" id="L207">        } catch (HttpClientErrorException e) {</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            return e.getStatusCode() == HttpStatus.NOT_FOUND;</span>
<span class="nc" id="L209">        } catch (Exception e) {</span>
<span class="nc" id="L210">            logger.warn(&quot;[PIX] Health check falhou: {}&quot;, e.getMessage());</span>
<span class="nc" id="L211">            return false;</span>
        }
    }

    @Override
    public String getGatewayCode() {
<span class="nc" id="L217">        return GATEWAY_CODE;</span>
    }

    private void validateRequest(AuthorizationRequest request) {
<span class="nc bnc" id="L221" title="All 4 branches missed.">        if (request.getAmount() == null || request.getAmount() &lt;= 0) {</span>
<span class="nc" id="L222">            throw new IllegalArgumentException(&quot;Valor inválido&quot;);</span>
        }
<span class="nc bnc" id="L224" title="All 4 branches missed.">        if (request.getCardToken() == null || request.getCardToken().isEmpty()) {</span>
<span class="nc" id="L225">            throw new IllegalArgumentException(&quot;Token do cartão obrigatório&quot;);</span>
        }
<span class="nc" id="L227">    }</span>

    private Map&lt;String, Object&gt; buildAuthorizationPayload(AuthorizationRequest request, Transacao transacao) {
<span class="nc" id="L230">        Map&lt;String, Object&gt; payload = new HashMap&lt;&gt;();</span>
<span class="nc" id="L231">        payload.put(&quot;transaction_id&quot;, transacao.getTransactionId());</span>
<span class="nc" id="L232">        payload.put(&quot;amount&quot;, request.getAmount());</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        payload.put(&quot;currency&quot;, request.getCurrency() != null ? request.getCurrency() : &quot;BRL&quot;);</span>
<span class="nc" id="L234">        payload.put(&quot;card_token&quot;, request.getCardToken());</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        payload.put(&quot;installments&quot;, request.getInstallments() != null ? request.getInstallments() : 1);</span>
<span class="nc" id="L236">        payload.put(&quot;capture&quot;, false);</span>
        
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (request.getCustomer() != null) {</span>
<span class="nc" id="L239">            payload.put(&quot;customer&quot;, request.getCustomer());</span>
        }
        
<span class="nc" id="L242">        return payload;</span>
    }

    private HttpHeaders buildHeaders(Gateway gateway) {
<span class="nc" id="L246">        HttpHeaders headers = new HttpHeaders();</span>
<span class="nc" id="L247">        headers.setContentType(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L248">        headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + gateway.getMerchantKey());</span>
<span class="nc" id="L249">        headers.set(&quot;X-Request-Id&quot;, UUID.randomUUID().toString());</span>
<span class="nc" id="L250">        return headers;</span>
    }

    private String getBaseUrl(Gateway gateway) {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        return gateway.getAmbiente().toString().equals(&quot;SANDBOX&quot;) ? SANDBOX_URL : PRODUCTION_URL;</span>
    }

    private PaymentResponse processAuthorizationResponse(ResponseEntity&lt;Map&gt; response, Transacao transacao) {
<span class="nc bnc" id="L258" title="All 4 branches missed.">        if (response.getStatusCode() == HttpStatus.CREATED || response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L259">            Map&lt;String, Object&gt; responseBody = response.getBody();</span>

<span class="nc" id="L261">            PaymentResponse paymentResponse = new PaymentResponse();</span>
<span class="nc" id="L262">            paymentResponse.setSuccess(true);</span>
<span class="nc" id="L263">            paymentResponse.setStatus(&quot;AUTHORIZED&quot;);</span>
<span class="nc" id="L264">            paymentResponse.setTransactionId(transacao.getTransactionId());</span>
<span class="nc" id="L265">            paymentResponse.setGatewayTransactionId((String) responseBody.get(&quot;id&quot;));</span>
<span class="nc" id="L266">            paymentResponse.setAuthorizationCode((String) responseBody.get(&quot;authorization_code&quot;));</span>
<span class="nc" id="L267">            paymentResponse.setTimestamp(ZonedDateTime.now());</span>

<span class="nc" id="L269">            logger.info(&quot;[PIX] Autorização bem-sucedida: {}&quot;, paymentResponse.getGatewayTransactionId());</span>
<span class="nc" id="L270">            return paymentResponse;</span>
        } else {
<span class="nc" id="L272">            return createErrorResponse(&quot;AUTHORIZATION_FAILED&quot;, &quot;Falha na autorização&quot;);</span>
        }
    }

    private PaymentResponse createErrorResponse(String errorCode, String errorMessage) {
<span class="nc" id="L277">        PaymentResponse response = new PaymentResponse();</span>
<span class="nc" id="L278">        response.setSuccess(false);</span>
<span class="nc" id="L279">        response.setErrorCode(errorCode);</span>
<span class="nc" id="L280">        response.setErrorMessage(errorMessage);</span>
<span class="nc" id="L281">        response.setTimestamp(ZonedDateTime.now());</span>
<span class="nc" id="L282">        return response;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>