<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RedeAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Payment Integration Platform</a> &gt; <a href="index.source.html" class="el_package">com.pip.gateway</a> &gt; <span class="el_source">RedeAdapter.java</span></div><h1>RedeAdapter.java</h1><pre class="source lang-java linenums">package com.pip.gateway;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.pip.dto.AuthorizationRequest;
import com.pip.dto.CaptureRequest;
import com.pip.dto.VoidRequest;
import com.pip.dto.PaymentResponse;
import com.pip.model.Gateway;
import com.pip.model.Transacao;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.*;
import org.springframework.stereotype.Component;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.HttpServerErrorException;
import org.springframework.web.client.RestTemplate;

import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * Adaptador REAL para integração com Rede e.Rede API
 * 
 * Implementação 100% conforme documentação oficial:
 * https://developer.userede.com.br/e-rede
 * 
 * Características:
 * - Autenticação via OAuth 2.0 (novo padrão desde 05/01/2026)
 * - Ambiente Sandbox: https://api-sandbox.userede.com.br/erede
 * - Ambiente Produção: https://api.userede.com.br/erede
 * - Suporta: Autorização, Captura Posterior, Captura Automática, Cancelamento
 * - Valores sem separador de milhar e decimal
 * - Tokenização de cartões (PCI-DSS compliant)
 * - 3D Secure 2.0 support
 * 
 * Segurança:
 * - TLS 1.2+ obrigatório
 * - OAuth 2.0 com access_token (validade 24 minutos)
 * - PCI-DSS Level 1 compliant
 * - Certificado Digital Rede
 * - Logs de auditoria completos
 * - Sanitização de dados sensíveis
 * 
 * @author Luiz Gustavo Finotello
 * @version 3.0 - 100% Conforme Documentação Oficial + OAuth 2.0
 */
@Component
<span class="nc" id="L53">public class RedeAdapter implements GatewayAdapter {</span>

<span class="nc" id="L55">    private static final Logger logger = LoggerFactory.getLogger(RedeAdapter.class);</span>
    private static final String GATEWAY_CODE = &quot;REDE&quot;;
    
    // URLs oficiais Rede conforme documentação
    private static final String SANDBOX_URL = &quot;https://api-sandbox.userede.com.br/erede&quot;;
    private static final String PRODUCTION_URL = &quot;https://api.userede.com.br/erede&quot;;
    private static final String OAUTH_URL = &quot;https://api.userede.com.br/redelabs/oauth2/token&quot;;
    
    // Cache do access_token (simplificado - em produção usar Redis)
    private String cachedAccessToken;
    private long tokenExpirationTime;

    @Autowired
    private RestTemplate restTemplate;

    @Autowired
    private ObjectMapper objectMapper;

    @Override
    public PaymentResponse authorize(Gateway gateway, AuthorizationRequest request, Transacao transacao) {
<span class="nc" id="L75">        logger.info(&quot;[REDE] Iniciando autorização - TransactionID: {}&quot;, transacao.getTransactionId());</span>
        
        try {
            // Validações de segurança
<span class="nc" id="L79">            validateRequest(request);</span>
            
            // Obter access_token OAuth 2.0
<span class="nc" id="L82">            String accessToken = getAccessToken(gateway);</span>
            
            // Construir payload COMPLETO conforme documentação Rede
<span class="nc" id="L85">            Map&lt;String, Object&gt; payload = buildCompleteAuthorizationPayload(request, transacao);</span>
            
            // Configurar headers com OAuth 2.0
<span class="nc" id="L88">            HttpHeaders headers = buildOAuthHeaders(accessToken);</span>
            
            // Fazer requisição
<span class="nc" id="L91">            String url = getBaseUrl(gateway) + &quot;/v2/transactions&quot;;</span>
<span class="nc" id="L92">            HttpEntity&lt;Map&lt;String, Object&gt;&gt; entity = new HttpEntity&lt;&gt;(payload, headers);</span>
            
<span class="nc" id="L94">            logger.debug(&quot;[REDE] Enviando requisição para: {}&quot;, url);</span>
            
<span class="nc" id="L96">            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.POST,
                entity,
                Map.class
            );

            // Processar resposta
<span class="nc" id="L104">            return processAuthorizationResponse(response, transacao);</span>

<span class="nc" id="L106">        } catch (HttpClientErrorException e) {</span>
<span class="nc" id="L107">            logger.error(&quot;[REDE] Erro 4xx na autorização: {} - {}&quot;, e.getStatusCode(), sanitizeLog(e.getResponseBodyAsString()));</span>
<span class="nc" id="L108">            return createErrorResponse(&quot;AUTHORIZATION_FAILED&quot;, parseErrorMessage(e.getResponseBodyAsString()));</span>
<span class="nc" id="L109">        } catch (HttpServerErrorException e) {</span>
<span class="nc" id="L110">            logger.error(&quot;[REDE] Erro 5xx na autorização: {} - {}&quot;, e.getStatusCode(), e.getMessage());</span>
<span class="nc" id="L111">            return createErrorResponse(&quot;GATEWAY_ERROR&quot;, &quot;Erro no gateway Rede&quot;);</span>
<span class="nc" id="L112">        } catch (Exception e) {</span>
<span class="nc" id="L113">            logger.error(&quot;[REDE] Erro inesperado na autorização&quot;, e);</span>
<span class="nc" id="L114">            return createErrorResponse(&quot;SYSTEM_ERROR&quot;, &quot;Erro no sistema&quot;);</span>
        }
    }

    @Override
    public PaymentResponse capture(Gateway gateway, CaptureRequest request, Transacao transacao) {
<span class="nc" id="L120">        logger.info(&quot;[REDE] Iniciando captura - TransactionID: {}&quot;, transacao.getTransactionId());</span>

        try {
<span class="nc bnc" id="L123" title="All 2 branches missed.">            if (transacao.getGatewayTransactionId() == null) {</span>
<span class="nc" id="L124">                return createErrorResponse(&quot;INVALID_TRANSACTION&quot;, &quot;TID não encontrado&quot;);</span>
            }
            
            // Obter access_token OAuth 2.0
<span class="nc" id="L128">            String accessToken = getAccessToken(gateway);</span>
            
            // Configurar headers
<span class="nc" id="L131">            HttpHeaders headers = buildOAuthHeaders(accessToken);</span>

            // URL de captura - PUT /v2/transactions/{tid}
<span class="nc" id="L134">            String url = String.format(&quot;%s/v2/transactions/%s&quot;,</span>
<span class="nc" id="L135">                getBaseUrl(gateway),</span>
<span class="nc" id="L136">                transacao.getGatewayTransactionId()</span>
            );
            
            // Body com amount (opcional para captura parcial)
<span class="nc" id="L140">            Map&lt;String, Object&gt; body = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">            if (request.getAmount() != null &amp;&amp; request.getAmount().compareTo(java.math.BigDecimal.ZERO) &gt; 0) {</span>
                // Valor sem separador de milhar e decimal (ex: R$10,00 = 1000)
<span class="nc" id="L143">                body.put(&quot;amount&quot;, request.getAmount().multiply(java.math.BigDecimal.valueOf(100)).intValue());</span>
            }

<span class="nc" id="L146">            HttpEntity&lt;Map&lt;String, Object&gt;&gt; entity = new HttpEntity&lt;&gt;(body, headers);</span>
            
<span class="nc" id="L148">            logger.debug(&quot;[REDE] Enviando captura para: {}&quot;, url);</span>
            
<span class="nc" id="L150">            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.PUT,
                entity,
                Map.class
            );

            // Processar resposta
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L159">                Map&lt;String, Object&gt; responseBody = response.getBody();</span>
                
<span class="nc" id="L161">                PaymentResponse paymentResponse = new PaymentResponse();</span>
<span class="nc" id="L162">                paymentResponse.setSuccess(true);</span>
<span class="nc" id="L163">                paymentResponse.setStatus(&quot;CAPTURED&quot;);</span>
<span class="nc" id="L164">                paymentResponse.setTransactionId(transacao.getTransactionId());</span>
<span class="nc" id="L165">                paymentResponse.setGatewayTransactionId((String) responseBody.get(&quot;tid&quot;));</span>
<span class="nc" id="L166">                paymentResponse.setAuthorizationCode((String) responseBody.get(&quot;authorizationCode&quot;));</span>
<span class="nc" id="L167">                paymentResponse.setNsu((String) responseBody.get(&quot;nsu&quot;));</span>
<span class="nc" id="L168">                paymentResponse.setTimestamp(ZonedDateTime.now());</span>

<span class="nc" id="L170">                logger.info(&quot;[REDE] Captura bem-sucedida: {}&quot;, transacao.getGatewayTransactionId());</span>
<span class="nc" id="L171">                return paymentResponse;</span>
            } else {
<span class="nc" id="L173">                return createErrorResponse(&quot;CAPTURE_FAILED&quot;, &quot;Falha na captura Rede&quot;);</span>
            }

<span class="nc" id="L176">        } catch (HttpClientErrorException e) {</span>
<span class="nc" id="L177">            logger.error(&quot;[REDE] Erro 4xx na captura: {} - {}&quot;, e.getStatusCode(), sanitizeLog(e.getResponseBodyAsString()));</span>
<span class="nc" id="L178">            return createErrorResponse(&quot;CAPTURE_FAILED&quot;, parseErrorMessage(e.getResponseBodyAsString()));</span>
<span class="nc" id="L179">        } catch (Exception e) {</span>
<span class="nc" id="L180">            logger.error(&quot;[REDE] Erro na captura&quot;, e);</span>
<span class="nc" id="L181">            return createErrorResponse(&quot;GATEWAY_ERROR&quot;, e.getMessage());</span>
        }
    }

    @Override
    public PaymentResponse voidTransaction(Gateway gateway, VoidRequest request, Transacao transacao) {
<span class="nc" id="L187">        logger.info(&quot;[REDE] Iniciando cancelamento - TransactionID: {}&quot;, transacao.getTransactionId());</span>

        try {
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (transacao.getGatewayTransactionId() == null) {</span>
<span class="nc" id="L191">                return createErrorResponse(&quot;INVALID_TRANSACTION&quot;, &quot;TID não encontrado&quot;);</span>
            }
            
            // Obter access_token OAuth 2.0
<span class="nc" id="L195">            String accessToken = getAccessToken(gateway);</span>
            
            // Configurar headers
<span class="nc" id="L198">            HttpHeaders headers = buildOAuthHeaders(accessToken);</span>

            // URL de cancelamento - DELETE /v2/transactions/{tid}
<span class="nc" id="L201">            String url = String.format(&quot;%s/v2/transactions/%s&quot;,</span>
<span class="nc" id="L202">                getBaseUrl(gateway),</span>
<span class="nc" id="L203">                transacao.getGatewayTransactionId()</span>
            );
            
            // Body com amount (opcional para cancelamento parcial)
<span class="nc" id="L207">            Map&lt;String, Object&gt; body = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">            if (request.getAmount() != null &amp;&amp; request.getAmount() &gt; 0) {</span>
<span class="nc" id="L209">                body.put(&quot;amount&quot;, (int) (request.getAmount() * 100));</span>
            }

<span class="nc" id="L212">            HttpEntity&lt;Map&lt;String, Object&gt;&gt; entity = new HttpEntity&lt;&gt;(body, headers);</span>
            
<span class="nc" id="L214">            logger.debug(&quot;[REDE] Enviando cancelamento para: {}&quot;, url);</span>
            
<span class="nc" id="L216">            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(</span>
                url,
                HttpMethod.DELETE,
                entity,
                Map.class
            );

            // Processar resposta
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L225">                Map&lt;String, Object&gt; responseBody = response.getBody();</span>
                
<span class="nc" id="L227">                PaymentResponse paymentResponse = new PaymentResponse();</span>
<span class="nc" id="L228">                paymentResponse.setSuccess(true);</span>
<span class="nc" id="L229">                paymentResponse.setStatus(&quot;VOIDED&quot;);</span>
<span class="nc" id="L230">                paymentResponse.setTransactionId(transacao.getTransactionId());</span>
<span class="nc" id="L231">                paymentResponse.setGatewayTransactionId(transacao.getGatewayTransactionId());</span>
                
                // returnCode e returnMessage
<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (responseBody.containsKey(&quot;returnCode&quot;)) {</span>
<span class="nc" id="L235">                    paymentResponse.setAuthorizationCode((String) responseBody.get(&quot;returnCode&quot;));</span>
                }
                
<span class="nc" id="L238">                paymentResponse.setTimestamp(ZonedDateTime.now());</span>

<span class="nc" id="L240">                logger.info(&quot;[REDE] Cancelamento bem-sucedido: {}&quot;, transacao.getGatewayTransactionId());</span>
<span class="nc" id="L241">                return paymentResponse;</span>
            } else {
<span class="nc" id="L243">                return createErrorResponse(&quot;VOID_FAILED&quot;, &quot;Falha no cancelamento Rede&quot;);</span>
            }

<span class="nc" id="L246">        } catch (HttpClientErrorException e) {</span>
<span class="nc" id="L247">            logger.error(&quot;[REDE] Erro 4xx no cancelamento: {} - {}&quot;, e.getStatusCode(), sanitizeLog(e.getResponseBodyAsString()));</span>
<span class="nc" id="L248">            return createErrorResponse(&quot;VOID_FAILED&quot;, parseErrorMessage(e.getResponseBodyAsString()));</span>
<span class="nc" id="L249">        } catch (Exception e) {</span>
<span class="nc" id="L250">            logger.error(&quot;[REDE] Erro no cancelamento&quot;, e);</span>
<span class="nc" id="L251">            return createErrorResponse(&quot;GATEWAY_ERROR&quot;, e.getMessage());</span>
        }
    }

    @Override
    public boolean healthCheck(Gateway gateway) {
        try {
            // Tentar obter access_token
<span class="nc" id="L259">            String accessToken = getAccessToken(gateway);</span>
            
<span class="nc bnc" id="L261" title="All 4 branches missed.">            if (accessToken != null &amp;&amp; !accessToken.isEmpty()) {</span>
<span class="nc" id="L262">                logger.debug(&quot;[REDE] Health check: OK&quot;);</span>
<span class="nc" id="L263">                return true;</span>
            }
            
<span class="nc" id="L266">            return false;</span>

<span class="nc" id="L268">        } catch (Exception e) {</span>
<span class="nc" id="L269">            logger.warn(&quot;[REDE] Health check falhou: {}&quot;, e.getMessage());</span>
<span class="nc" id="L270">            return false;</span>
        }
    }

    @Override
    public String getGatewayCode() {
<span class="nc" id="L276">        return GATEWAY_CODE;</span>
    }

    // ========== MÉTODOS PRIVADOS ==========

    /**
     * Obtém access_token OAuth 2.0
     * Token tem validade de 24 minutos conforme documentação
     */
    private String getAccessToken(Gateway gateway) {
        // Verificar se token em cache ainda é válido
<span class="nc bnc" id="L287" title="All 4 branches missed.">        if (cachedAccessToken != null &amp;&amp; System.currentTimeMillis() &lt; tokenExpirationTime) {</span>
<span class="nc" id="L288">            logger.debug(&quot;[REDE] Usando access_token em cache&quot;);</span>
<span class="nc" id="L289">            return cachedAccessToken;</span>
        }
        
        try {
<span class="nc" id="L293">            logger.info(&quot;[REDE] Obtendo novo access_token OAuth 2.0&quot;);</span>
            
            // Construir Basic Auth com clientId e clientSecret
<span class="nc" id="L296">            String auth = gateway.getMerchantId() + &quot;:&quot; + gateway.getMerchantKey();</span>
<span class="nc" id="L297">            String encodedAuth = Base64.getEncoder().encodeToString(auth.getBytes());</span>
            
<span class="nc" id="L299">            HttpHeaders headers = new HttpHeaders();</span>
<span class="nc" id="L300">            headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span>
<span class="nc" id="L301">            headers.set(&quot;Authorization&quot;, &quot;Basic &quot; + encodedAuth);</span>
            
            // Body com grant_type
<span class="nc" id="L304">            String body = &quot;grant_type=client_credentials&quot;;</span>
            
<span class="nc" id="L306">            HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(body, headers);</span>
            
<span class="nc" id="L308">            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(</span>
                OAUTH_URL,
                HttpMethod.POST,
                entity,
                Map.class
            );
            
<span class="nc bnc" id="L315" title="All 2 branches missed.">            if (response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L316">                Map&lt;String, Object&gt; responseBody = response.getBody();</span>
<span class="nc" id="L317">                cachedAccessToken = (String) responseBody.get(&quot;access_token&quot;);</span>
                
                // Token expira em 24 minutos (1440 segundos)
                // Renovar 1 minuto antes para segurança
<span class="nc" id="L321">                tokenExpirationTime = System.currentTimeMillis() + (23 * 60 * 1000);</span>
                
<span class="nc" id="L323">                logger.info(&quot;[REDE] Access_token obtido com sucesso&quot;);</span>
<span class="nc" id="L324">                return cachedAccessToken;</span>
            }
            
<span class="nc" id="L327">            throw new RuntimeException(&quot;Falha ao obter access_token&quot;);</span>
            
<span class="nc" id="L329">        } catch (Exception e) {</span>
<span class="nc" id="L330">            logger.error(&quot;[REDE] Erro ao obter access_token&quot;, e);</span>
<span class="nc" id="L331">            throw new RuntimeException(&quot;Erro na autenticação OAuth 2.0&quot;, e);</span>
        }
    }

    /**
     * Valida requisição de autorização
     */
    private void validateRequest(AuthorizationRequest request) {
<span class="nc bnc" id="L339" title="All 4 branches missed.">        if (request.getAmount() == null || request.getAmount() &lt;= 0) {</span>
<span class="nc" id="L340">            throw new IllegalArgumentException(&quot;Valor inválido&quot;);</span>
        }
<span class="nc bnc" id="L342" title="All 4 branches missed.">        if (request.getCardToken() == null || request.getCardToken().isEmpty()) {</span>
<span class="nc" id="L343">            throw new IllegalArgumentException(&quot;Token do cartão obrigatório&quot;);</span>
        }
<span class="nc" id="L345">    }</span>

    /**
     * Constrói payload COMPLETO conforme documentação Rede
     */
    private Map&lt;String, Object&gt; buildCompleteAuthorizationPayload(AuthorizationRequest request, Transacao transacao) {
<span class="nc" id="L351">        Map&lt;String, Object&gt; payload = new HashMap&lt;&gt;();</span>
        
        // ===== REFERENCE (obrigatório) =====
<span class="nc" id="L354">        payload.put(&quot;reference&quot;, transacao.getTransactionId());</span>
        
        // ===== ORDERID (opcional) =====
<span class="nc" id="L357">        payload.put(&quot;orderId&quot;, transacao.getTransactionId());</span>
        
        // ===== AMOUNT (obrigatório) - sem separador de milhar e decimal =====
        // Exemplo: R$10,00 = 1000
<span class="nc" id="L361">        payload.put(&quot;amount&quot;, (int) (request.getAmount() * 100));</span>
        
        // ===== INSTALLMENTS (obrigatório) =====
<span class="nc bnc" id="L364" title="All 2 branches missed.">        payload.put(&quot;installments&quot;, request.getInstallments() != null ? request.getInstallments() : 1);</span>
        
        // ===== CARDHOLDERTOKEN (obrigatório para tokenização) =====
<span class="nc" id="L367">        payload.put(&quot;cardholderToken&quot;, request.getCardToken());</span>
        
        // ===== KIND (obrigatório) =====
        // credit = crédito, debit = débito
<span class="nc" id="L371">        payload.put(&quot;kind&quot;, &quot;credit&quot;);</span>
        
        // ===== CAPTURE (opcional) =====
        // true = captura automática, false = captura posterior
<span class="nc" id="L375">        payload.put(&quot;capture&quot;, false);</span>
        
        // ===== SOFTDESCRIPTOR (opcional) =====
<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (request.getSoftDescriptor() != null) {</span>
<span class="nc" id="L379">            payload.put(&quot;softDescriptor&quot;, request.getSoftDescriptor());</span>
        }
        
        // IATA e ThreeDS são strings simples ou devem ser tratados separadamente se necessário
        
        // ThreeDS - se necessário, usar os dados do Map
<span class="nc bnc" id="L385" title="All 4 branches missed.">        if (request.getThreeDS() != null &amp;&amp; !request.getThreeDS().isEmpty()) {</span>
<span class="nc" id="L386">            payload.put(&quot;threeds&quot;, request.getThreeDS());</span>
        }
        
<span class="nc" id="L389">        logger.debug(&quot;[REDE] Payload construído com {} campos principais&quot;, payload.size());</span>
        
<span class="nc" id="L391">        return payload;</span>
    }

    /**
     * Constrói headers com OAuth 2.0
     */
    private HttpHeaders buildOAuthHeaders(String accessToken) {
<span class="nc" id="L398">        HttpHeaders headers = new HttpHeaders();</span>
<span class="nc" id="L399">        headers.setContentType(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L400">        headers.set(&quot;accept&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L401">        headers.set(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
        
<span class="nc" id="L403">        logger.debug(&quot;[REDE] Headers OAuth 2.0 configurados&quot;);</span>
        
<span class="nc" id="L405">        return headers;</span>
    }

    /**
     * Retorna URL base conforme ambiente
     */
    private String getBaseUrl(Gateway gateway) {
<span class="nc bnc" id="L412" title="All 2 branches missed.">        return gateway.getAmbiente().toString().equals(&quot;SANDBOX&quot;) ? SANDBOX_URL : PRODUCTION_URL;</span>
    }

    /**
     * Processa resposta de autorização
     */
    private PaymentResponse processAuthorizationResponse(ResponseEntity&lt;Map&gt; response, Transacao transacao) {
<span class="nc bnc" id="L419" title="All 4 branches missed.">        if (response.getStatusCode() == HttpStatus.CREATED || response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L420">            Map&lt;String, Object&gt; responseBody = response.getBody();</span>

<span class="nc" id="L422">            PaymentResponse paymentResponse = new PaymentResponse();</span>
            
            // returnCode: 00 = aprovado, outros = negado
<span class="nc" id="L425">            String returnCode = (String) responseBody.get(&quot;returnCode&quot;);</span>
<span class="nc" id="L426">            boolean isAuthorized = &quot;00&quot;.equals(returnCode);</span>
            
<span class="nc" id="L428">            paymentResponse.setSuccess(isAuthorized);</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">            paymentResponse.setStatus(isAuthorized ? &quot;AUTHORIZED&quot; : &quot;DENIED&quot;);</span>
<span class="nc" id="L430">            paymentResponse.setTransactionId(transacao.getTransactionId());</span>
<span class="nc" id="L431">            paymentResponse.setGatewayTransactionId((String) responseBody.get(&quot;tid&quot;));</span>
<span class="nc" id="L432">            paymentResponse.setAuthorizationCode((String) responseBody.get(&quot;authorizationCode&quot;));</span>
<span class="nc" id="L433">            paymentResponse.setNsu((String) responseBody.get(&quot;nsu&quot;));</span>
            
            // dateTime no formato YYYY-MM-DDThh:mm:ss.sTZD
<span class="nc bnc" id="L436" title="All 2 branches missed.">            if (responseBody.containsKey(&quot;dateTime&quot;)) {</span>
<span class="nc" id="L437">                String dateTime = (String) responseBody.get(&quot;dateTime&quot;);</span>
<span class="nc" id="L438">                paymentResponse.setTimestamp(ZonedDateTime.parse(dateTime, DateTimeFormatter.ISO_DATE_TIME));</span>
<span class="nc" id="L439">            } else {</span>
<span class="nc" id="L440">                paymentResponse.setTimestamp(ZonedDateTime.now());</span>
            }
            
<span class="nc bnc" id="L443" title="All 2 branches missed.">            if (!isAuthorized) {</span>
<span class="nc" id="L444">                paymentResponse.setErrorCode(returnCode);</span>
<span class="nc" id="L445">                paymentResponse.setErrorMessage((String) responseBody.get(&quot;returnMessage&quot;));</span>
            }
            
            // Brand information
<span class="nc bnc" id="L449" title="All 2 branches missed.">            if (responseBody.containsKey(&quot;brand&quot;)) {</span>
<span class="nc" id="L450">                Map&lt;String, Object&gt; brand = (Map&lt;String, Object&gt;) responseBody.get(&quot;brand&quot;);</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">                if (brand.containsKey(&quot;name&quot;)) {</span>
<span class="nc" id="L452">                    paymentResponse.setCardBrand((String) brand.get(&quot;name&quot;));</span>
                }
            }

<span class="nc" id="L456">            logger.info(&quot;[REDE] Autorização processada: {} - Status: {} - Code: {}&quot;, </span>
<span class="nc" id="L457">                paymentResponse.getGatewayTransactionId(), </span>
<span class="nc" id="L458">                paymentResponse.getStatus(),</span>
                returnCode);
            
<span class="nc" id="L461">            return paymentResponse;</span>
        } else {
<span class="nc" id="L463">            return createErrorResponse(&quot;AUTHORIZATION_FAILED&quot;, &quot;Falha na autorização Rede&quot;);</span>
        }
    }

    /**
     * Sanitiza logs removendo dados sensíveis
     */
    private String sanitizeLog(String log) {
<span class="nc bnc" id="L471" title="All 2 branches missed.">        if (log == null) return &quot;&quot;;</span>
        
<span class="nc" id="L473">        return log.replaceAll(&quot;\\d{13,19}&quot;, &quot;****&quot;)</span>
<span class="nc" id="L474">                  .replaceAll(&quot;cardNumber[\&quot;:]\\s*\\d+&quot;, &quot;cardNumber\&quot;:\&quot;****\&quot;&quot;)</span>
<span class="nc" id="L475">                  .replaceAll(&quot;securityCode[\&quot;:]\\s*\\d{3,4}&quot;, &quot;securityCode\&quot;:\&quot;***\&quot;&quot;)</span>
<span class="nc" id="L476">                  .replaceAll(&quot;cvv[\&quot;:]\\s*\\d{3,4}&quot;, &quot;cvv\&quot;:\&quot;***\&quot;&quot;);</span>
    }

    /**
     * Extrai mensagem de erro do response body
     */
    private String parseErrorMessage(String responseBody) {
        try {
<span class="nc" id="L484">            Map&lt;String, Object&gt; errorBody = objectMapper.readValue(responseBody, Map.class);</span>
            
<span class="nc bnc" id="L486" title="All 2 branches missed.">            if (errorBody.containsKey(&quot;returnMessage&quot;)) {</span>
<span class="nc" id="L487">                return (String) errorBody.get(&quot;returnMessage&quot;);</span>
            }
            
<span class="nc bnc" id="L490" title="All 2 branches missed.">            if (errorBody.containsKey(&quot;message&quot;)) {</span>
<span class="nc" id="L491">                return (String) errorBody.get(&quot;message&quot;);</span>
            }
<span class="nc" id="L493">        } catch (Exception e) {</span>
<span class="nc" id="L494">            logger.debug(&quot;[REDE] Não foi possível parsear mensagem de erro&quot;);</span>
<span class="nc" id="L495">        }</span>
<span class="nc" id="L496">        return &quot;Erro na transação&quot;;</span>
    }

    /**
     * Cria resposta de erro padronizada
     */
    private PaymentResponse createErrorResponse(String errorCode, String errorMessage) {
<span class="nc" id="L503">        PaymentResponse response = new PaymentResponse();</span>
<span class="nc" id="L504">        response.setSuccess(false);</span>
<span class="nc" id="L505">        response.setErrorCode(errorCode);</span>
<span class="nc" id="L506">        response.setErrorMessage(errorMessage);</span>
<span class="nc" id="L507">        response.setTimestamp(ZonedDateTime.now());</span>
        
<span class="nc" id="L509">        logger.warn(&quot;[REDE] Erro: {} - {}&quot;, errorCode, errorMessage);</span>
        
<span class="nc" id="L511">        return response;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>